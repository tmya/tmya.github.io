<!doctype html>
<html lang="ja" itemscope itemtype="http://schema.org/Person">
<head>
            <meta charset="utf-8">
        <!-- Site Meta Data -->
        <title>GnuPGを運用する</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="Akio Tomita">

        <link rel="shortcut icon" href="">

        <!-- schema.org -->
        <meta itemprop="name" content="tmya note">
        <meta itemprop="image" content="">
        <meta itemprop="description" content="">

        <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
        <!-- Style Meta Data -->
        <link rel="stylesheet" href="./theme/css/style.css" type="text/css"/>
        <link rel="stylesheet" href="./theme/css/pygments.css" type="text/css"/>

        <!-- Feed Meta Data -->

        <!-- Twitter Feed -->
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="">
        <meta name="twitter:image" content="">

    <meta name="twitter:creator" content="">
    <meta name="twitter:url" content="./miracle-linux-9-tips-gpg.html">
    <meta name="twitter:title" content="tmya note ~ GnuPGを運用する">
    <meta name="twitter:description" content="GnuPGを運用する（準備編） GnuPGとは GnuPGを使うと、通信の秘密を守ることができます。そのために公開鍵暗号方式が採用されています。 データの暗号化や …">

    <!-- Facebook Meta Data -->
    <meta property="og:title" content="tmya note ~ GnuPGを運用する"/>
    <meta property="og:description" content="GnuPGを運用する（準備編） GnuPGとは GnuPGを使うと、通信の秘密を守ることができます。そのために公開鍵暗号方式が採用されています。 データの暗号化や …"/>
    <meta property="og:image" content=""/>
</head>

<body>
<!-- Sidebar -->
<aside>
    <!--<center><a href="."><img id="avatar" src=""></a></center>-->
    <h1>tmya note</h1>
        <p>Something else</p>
    <br>


    <nav class="nav">
        <ul class="list-bare">

                <li><a class="nav__link" href="https://tmya.github.io">Blog</a></li>

                <li><a class="nav__link" href="./pages/about.html">About</a></li>

        </ul>
    </nav>

    <p class="social">
                <a href="https://github.com/tmya" target="_blank"><img
                        src="./theme/images/icons/github.png"></a>
                <a href="https://twitter.com/tmyanote" target="_blank"><img
                        src="./theme/images/icons/twitter.png"></a>
    </p>

        <h2>Categories</h2>
        <ul class="navbar">
                <li><a
                        href="./category/blog.html">blog</a></li>
                <li><a
                        href="./category/miracle-linux.html">MIRACLE LINUX</a></li>
                <li><a
                        href="./category/miracle-linux-84.html">MIRACLE LINUX 8.4</a></li>
                <li class="active"><a
                        href="./category/miracle-linux-9.html">MIRACLE LINUX 9</a></li>
                <li><a
                        href="./category/p-tips.html">p-tips</a></li>
        </ul>


</aside>

<!-- Content -->
<article>
    <section id="content">
        <article>
            <h2 class="post_title post_detail"><a href="./miracle-linux-9-tips-gpg.html" rel="bookmark"
                                                  title="Permalink to GnuPGを運用する">GnuPGを運用する</a></h2>
            <div class="entry-content blog-post">
                <h1>GnuPGを運用する（準備編）</h1>
<h2>GnuPGとは</h2>
<p>GnuPGを使うと、通信の秘密を守ることができます。そのために公開鍵暗号方式が採用されています。</p>
<p>データの暗号化や署名の用途に使うことが多いです。</p>
<p>詳しいことを抜きに話すと、一対の公開鍵と秘密鍵のペアを用意して、あらゆる相手先に同じ公開鍵を渡すので、相手側で公開鍵が漏洩してもそもそも公開されているので安全という事です。自分の持つ一つの秘密鍵は自分できちんと管理していれば安全です。
普通のパスワードの場合、どこからか漏洩したらすべての同じパスワードが危険になります。</p>
<p>この説明はgpgを使うのに大変苦労したので、GnuPGを使うために必要な知識と実際の使い方と雰囲気のメモと概説になります。</p>
<h2>MIRACLE LINUX 9 での使い方</h2>
<p>MIRACLE LINUX 9では、2022/12時点でGnuPGのバージョン 2.3.3が使われているようです。通常の使い方であれば問題ありません。
GnuPGを他のプログラムと連携を行う場合、別の設定やソフトウェアのインストールが必要になることがあります。（例えばSSH鍵として使ったり、OpenPGP card互換の機能を使うなど。）</p>
<h2>GnuPGを使う前に</h2>
<p>GnuPGのリリースは20年以上前になります。その為、現代(2022年)ではソフトウェアそのものの操作はもとより、仕組みから何からとても複雑に感じてしまいます。そういうプログラムであるという事を前提に取り組むと良いと思います。</p>
<h3>公開鍵暗号</h3>
<p>公開鍵暗号方式には、公開鍵と秘密鍵がペアで存在し、公開鍵はその名の通り公開する鍵（秘密にする必要がない）で、秘密鍵はその名の通り秘密にする鍵（他人に知られてはならない）です。</p>
<p>公開鍵暗号に対して、一般的に暗号化で思いつくのは共通鍵暗号です。これは一般的にパスワードとして使っているものです。一つのパスワードで暗号化と復号化を行います。</p>
<p>暗号化通信を行う場合に、公開鍵暗号では必要な鍵の数がn×2個なのに対して、共通鍵暗号では1/2×n×(n-1)個必要になります。つまり通信相手が多くなってくると、公開鍵暗号の方が鍵の数が少なくて鍵を管理する手間も少ないということになります。感覚的にも、公開鍵暗号は自分が鍵ペアを一つ持っていればいいことに対して、共通鍵暗号では通信相手毎にたくさんの鍵が必要だなということで分かるかと思います。</p>
<p>そして公開鍵暗号の用途は大きく次の3種類にわかれます。</p>
<h4>暗号化用途</h4>
<p>相手に暗号化したデータを送るために、相手の公開鍵を探してきて取得し、公開鍵でデータを暗号化します。この暗号化データは相手が持っている秘密鍵でのみ復号化できるので、インターネット経由で暗号化データを送っても安全です。</p>
<h4>署名用途</h4>
<p>自分が作成したデータですよと証明するためには、そのデータに対して自分の秘密鍵を用いて署名を行います。署名されたデータを公開した時に、相手はそのデータに署名がされているかを公開鍵を用いて確認することができます。データが改竄されていたりすると、署名の検証に失敗するので違うデータということがわかります。</p>
<p>どちらのパターンでも大事なのは、秘密鍵は自分だけが持っていることと公開鍵は公開していること。公開鍵については誰かが勝手になりすまして公開されないように、はっきりと自分だと言えることが大事になります。</p>
<h4>鍵配送用途</h4>
<p>これはGnuPGでは使わないと思いますが、公開鍵暗号の用途としては存在します。実は公開鍵暗号はその暗号化と復号化に必要な処理が、共通鍵暗号より多いのです。そのため、一つのデータと暗号化したり署名して送る用途にはいいのですが、ストリームデータの暗号化（映像配信など）を行う時にはちょっと不向きです。その為、最初だけ公開鍵暗号を使って、共通鍵を暗号化して相手に送ります。その後はその共通鍵を使って暗号通信を行うと効率的な暗号通信が可能です。GnuPGにはあまり関係しないので多くは書きません。</p>
<h4>公開鍵と秘密鍵の関係</h4>
<p>公開鍵暗号では公開鍵と秘密鍵のペアという説明を何度もしましたが、これは公開鍵を持っていても、秘密鍵を知ることはできないという特性があるためです。逆に、秘密鍵を知っていると公開鍵を知ることができます。</p>
<p>RSA暗号を例にすると、秘密鍵の中には素数<code>p</code>と<code>q</code>があります。適当に選んだ素数<code>p</code>と<code>q</code>をかけた値を<code>n</code>とします。<code>(p-1)(q-1)</code>と互いに素な数から適当に一つ数を選び、<code>e</code>とします。そして<code>e*d ≡ 1 mod φ(n)</code>(φ()はトーシェント関数)が成り立つように<code>d</code>を計算します。この<code>d</code>も秘密鍵の中に入れておきます。公開鍵には、<code>e</code>と<code>n</code>を入れておきましょう。<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup></p>
<div class="highlight"><pre><span></span><code>公開鍵の中身→ eとn
秘密鍵の中身→ pとqとd
</code></pre></div>

<p>暗号化は、欲しい暗号文を<code>c</code>(ciphertext)として元の平文を<code>m</code>(message)とすると、<code>c = m^e mod n</code>、復号化は<code>m = c^d mod n</code>となります。</p>
<p>公開鍵には<code>e</code>と<code>n</code>があるので、暗号化したいデータつまり<code>m</code>を用意すれば<code>c = m^e mod n</code>を計算できます。逆に、公開鍵で復号化しようとしても、<code>d</code>がわかりません。<code>d</code>を計算するためには、適当に選ばれた<code>e</code>を探す為に<code>n</code>を素因数分解して<code>p</code>と<code>q</code>を求めなければなりません。その<code>p</code>と<code>q</code>がとても大きい数の場合、現実的な時間で<code>p</code>と<code>q</code>を求めることができません。現実的な時間で求めることができない場合、その鍵は安全ということになります。なので、コンピュータの性能が上がると必要な<code>p</code>と<code>q</code>の大きさも増えていくことになります。</p>
<p>秘密鍵には<code>p</code>と<code>q</code>と<code>d</code>があり、復号化は<code>m = c^d mod n</code>なので、暗号文<code>c</code>があれば<code>m</code>を求めることができます。さらに、公開鍵の<code>e</code>は最初の計算通り<code>e*d ≡ 1 mod φ(n)</code>を満たすような<code>d</code>を探すと求めることができます。<code>n</code>は単純に<code>p</code>と<code>q</code>を掛けると求めることができます。</p>
<p>これが、公開鍵から秘密鍵を計算することはできないが、秘密鍵から公開鍵を計算することができるという仕組みです。</p>
<p>楕円曲線暗号は分からないので誰か教えてください。</p>
<h3>GnuPGのデータ構造</h3>
<h4>公開鍵データ</h4>
<p>gpgで生成される公開鍵には単純な公開鍵以外に、鍵の所有者や有効期限等のデータが一緒になっています。その為、有効期限を更新したり自分の名前やメールアドレスが変更になった場合は公開鍵を更新してみんなにお知らせする必要があるようです。ここに関しては詳しくないのであまり分かりません。</p>
<h4>たくさんの鍵</h4>
<p>使用していくと、鍵一覧にどんどん他の人の公開鍵が増えます。gpgでは特に自分の鍵と他人の鍵という区別はなさそうで、公開鍵があるか・秘密鍵があるかぐらいのようです。自分の鍵がどれなのか、きちんと後述する<code>keyid</code>や<code>fingerprint</code>を別途テキストに記録しておくと便利かもしれません。</p>
<h4>鍵の機能</h4>
<p>鍵には署名・暗号化等複数の機能を持たせることがあり、それぞれ別の機能をもった鍵として作ることもできます。
プログラム上でそれぞれ略称で<code>S</code>、<code>C</code>、<code>E</code>、<code>A</code>と表示されます。</p>
<table>
<thead>
<tr>
<th>略称</th>
<th>名称</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>S</td>
<td>Signing</td>
<td>署名(ファイル等へ署名する)</td>
</tr>
<tr>
<td>C</td>
<td>Certification</td>
<td>証明(副鍵を使うときに、主鍵に紐付いてることになる)</td>
</tr>
<tr>
<td>E</td>
<td>Encryption</td>
<td>暗号化(ファイル等を暗号化する)</td>
</tr>
<tr>
<td>A</td>
<td>Authentication</td>
<td>認証(SSH接続やPAM認証等)</td>
</tr>
</tbody>
</table>
<h4>主鍵と副鍵</h4>
<p>公開鍵と秘密鍵がセットで一つの鍵として考えた場合に、主となる鍵と、そこに紐付く複数の副鍵が存在します。
GnuPGでデフォルト設定のまま鍵を生成すると、まずは主鍵が作られて<code>S</code>と<code>C</code>の機能が付与され、自動的に副鍵に<code>E</code>の機能が付与された状態になります。</p>
<h4>鍵データの場所</h4>
<p>通常、鍵データ等は<code>$HOME/.gnupg/</code>以下に保存されています。セキュリティを保つために、ディレクトリのパーミッションは<code>700</code>になります。</p>
<p>また、鍵データがファイルで存在していることになりますが、ディレクトリを開いてファイル移動でコピーしたりバックアップしたりということはあまり想定されていないようです。直接ファイルを触ることはせず<code>gpg</code>コマンドを使って操作することが前提になります。</p>
<p>環境変数のGNUPGHOMEにパスを設定すると、そのパスが鍵データ等のディレクトリとしてgpgコマンドが実行されます。一時的に鍵を生成したり、インポート・エクスポート等を行う場合に重宝します。<code>export GNUPGHOME="$(mktemp -d)"</code>で環境変数を設定すると、以後のgpgコマンドは環境変数に指定したディレクトリのデータを基に動作するので、<code>$HOME/.gnupg/</code>以下に影響を与えることがありません。一通り作業が終わったら、<code>export -n GNUPGHOME</code>で環境変数を削除すると、以後gpgコマンドは<code>$HOME/.gnupg/</code>以下のデータを読み込むようになり、元に戻ります。なお、<code>gpg-agent</code>プロセスが立ち上がるので、<code>ps x | grep gpg-agent</code>を実行して表示された中で、<code>--homedir</code>以下が<code>/tmp/tmp.****</code>となっているもののプロセスを終了させましょう。左端の数値を覚えて、<code>kill xxxx</code>(xxxxに数値を入れる)で終了することができます。</p>
<p>一時的なフォルダを作って作業を行う場合</p>
<div class="highlight"><pre><span></span><code>$ <span class="nb">export</span> <span class="nv">GNUPGHOME</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>mktemp -d<span class="k">)</span><span class="s2">&quot;</span>
$ gpg --import hogehoge.key
...いろいろな作業
$ <span class="nb">export</span> -n GNUPGHOME
</code></pre></div>

<p>このような感じで作業します。<code>mktemp -d</code>で/tmp以下に一時的なフォルダを作って作業を行う方法は、<a href="https://www.gnupg.org/documentation/manuals/gnupg/Unattended-GPG-key-generation.html">公式の説明</a>の中にあった方法です。</p>
<p>この手法はエクスポートしたデータをきちんとインポートできるかのテストや、他にも役立つので重宝します。</p>
<h2>GnuPGを使う</h2>
<h3>概要</h3>
<p>GnuPGは<code>gpg</code>という実行ファイルになっています。<code>--version</code>オプションをつけるとインストールされているgpgのバージョンを確認できます。
再度になりますが、2022年12月時点のMIRACLE LINUX 9ではバージョンが<code>2.3.3</code>になっています。</p>
<div class="highlight"><pre><span></span><code>$ gpg --version
gpg <span class="o">(</span>GnuPG<span class="o">)</span> <span class="m">2</span>.3.3
libgcrypt <span class="m">1</span>.10.0-unknown
Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">2021</span> Free Software Foundation, Inc.
License GNU GPL-3.0-or-later &lt;https://gnu.org/licenses/gpl.html&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Home: /home/john/.gnupg
サポートしているアルゴリズム:
公開鍵: RSA, ELG, DSA, ECDH, ECDSA, EDDSA
暗号方式: IDEA, 3DES, CAST5, BLOWFISH, AES, AES192, AES256,
      TWOFISH, CAMELLIA128, CAMELLIA192, CAMELLIA256
AEAD: EAX, OCB
ハッシュ: SHA1, RIPEMD160, SHA256, SHA384, SHA512, SHA224
圧縮: 無圧縮, ZIP, ZLIB, BZIP2
</code></pre></div>

<p>もし<code>gpg</code>コマンドが見つからなかった場合は、GnuPGをインストールしてください。ついでに<code>pinenry</code>(PINをコンソールや画面から入力できる)もインストールすると良いでしょう。</p>
<div class="highlight"><pre><span></span><code>$ sudo dnf install gnupg pinentry
</code></pre></div>

<h4>心構え</h4>
<p><code>gpg</code>コマンドを使う時の個人的な印象と注意点ですが、とにかくオプションが多くなっていて覚えづらいことと、コマンドごとに動作の一貫性がないことがあります。またバージョンによって必要なオプションが違ったり、オプションの短縮形が存在したりしています。</p>
<p>他にもたくさん細かい注意点や補足があるので、都度書いておきます。</p>
<h4>オプションをつけよう</h4>
<p><code>gpg</code>コマンドをオプション無しで起動すると</p>
<div class="highlight"><pre><span></span><code>gpg: *警告*: コマンドが指定されていません。なにを意味しているのか当ててみます ...
gpg: 開始します。メッセージを打ってください ...
</code></pre></div>

<p>と表示されますが、当ててくれたことがないので<code>Ctrl-C</code>で終了する方が幸せになれると思います。
基本的にすべての操作はオプションをつけるとやりやすいと思います。</p>
<h4>オプションの指定</h4>
<p>オプションは、途中まで打って他とかぶらなければそのまま認識されるようです。
例 : <code>--list-ke</code> → --list-keys以外にないので--list-keysとして認識される。</p>
<h4>鍵の区別</h4>
<p>gpgでは鍵を個別に指定するのに複数の種類があるようです。
鍵IDとなる<code>keyid</code>に<code>short</code>と<code>long</code>、そして鍵の指紋である<code>fingerprint</code>があります。オプションではほとんど<code>keyid</code>を指定しますが、時々<code>fingerprint</code>が必要なことがあります。<code>keyid</code>の<code>short</code>と<code>long</code>は、重複しなければ<code>short</code>でよいみたいです。また<code>keyid</code>といいながらユーザの氏名やメールアドレスを指定しても部分一致で表示してくれるみたいです。
<code>keyid</code>をテキストに保存しておいて、毎回<code>cat my_keyid.txt</code>で読み込むという方法もいいかもしれません。</p>
<h3>目的別操作方法</h3>
<p>逆引きリファレンスみたいに使い方をメモしておきます。</p>
<h4>最初の鍵ペア(主鍵)作成</h4>
<p>早速鍵の生成に入りたいところですが、まずどんな種類の鍵を作るか考える必要があります。</p>
<p>通常、鍵ペアを作成するためのコマンドとしては<code>gpg --gen-key</code>(gpg --generate-keyの略)があります。このコマンドを実行し、本名とメールアドレス、そして秘密鍵を守る為のパスワードを入力すると鍵ペアが作成されます。この方法で作成しても問題はありません。この場合はRSAの3072bitで生成されるみたいです。
この場合、鍵ペアが二つ作られます。</p>
<p>ここでは<code>gpg --full-gen-key --expert</code>(gpg --full-generate-keyの略と--expertモード)を使って暗号の種類をECCにして生成してみたいと思います。
<code>--expert</code>をつけると、RSAとDSA以外を選ぶことができます。</p>
<div class="highlight"><pre><span></span><code>$ gpg --full-gen-key --expert
gpg <span class="o">(</span>GnuPG<span class="o">)</span> <span class="m">2</span>.3.3<span class="p">;</span> Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">2021</span> Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

ご希望の鍵の種類を選択してください:
   <span class="o">(</span><span class="m">1</span><span class="o">)</span> RSA and RSA <span class="o">(</span>default<span class="o">)</span>
   <span class="o">(</span><span class="m">2</span><span class="o">)</span> DSA and Elgamal
   <span class="o">(</span><span class="m">3</span><span class="o">)</span> DSA <span class="o">(</span>sign only<span class="o">)</span>
   <span class="o">(</span><span class="m">4</span><span class="o">)</span> RSA <span class="o">(</span>sign only<span class="o">)</span>
   <span class="o">(</span><span class="m">7</span><span class="o">)</span> DSA <span class="o">(</span><span class="nb">set</span> your own capabilities<span class="o">)</span>
   <span class="o">(</span><span class="m">8</span><span class="o">)</span> RSA <span class="o">(</span><span class="nb">set</span> your own capabilities<span class="o">)</span>
   <span class="o">(</span><span class="m">9</span><span class="o">)</span> ECC and ECC
  <span class="o">(</span><span class="m">10</span><span class="o">)</span> ECC <span class="o">(</span>署名のみ<span class="o">)</span>
  <span class="o">(</span><span class="m">11</span><span class="o">)</span> ECC <span class="o">(</span><span class="nb">set</span> your own capabilities<span class="o">)</span>
  <span class="o">(</span><span class="m">13</span><span class="o">)</span> Existing key
  <span class="o">(</span><span class="m">14</span><span class="o">)</span> Existing key from card
あなたの選択は? 
</code></pre></div>

<p><code>11</code>を入力します。</p>
<div class="highlight"><pre><span></span><code>あなたの選択は? <span class="m">11</span>

このECC鍵にありうる操作: Sign Certify Authenticate 
現在の認められた操作: Sign Certify 

   <span class="o">(</span>S<span class="o">)</span> 署名機能を反転する
   <span class="o">(</span>A<span class="o">)</span> 認証機能を反転する
   <span class="o">(</span>Q<span class="o">)</span> 完了
</code></pre></div>

<p>ここで生成する主鍵はCertificatio機能のみにして、Signは副鍵で作ることにしましょう。その為、現在認められた操作にSignが存在するので<code>S</code>を入力します。ちなみに<code>S</code>を入力する度に消えたり付与したりを繰り返します。</p>
<div class="highlight"><pre><span></span><code>あなたの選択は? s

このECC鍵にありうる操作: Sign Certify Authenticate 
現在の認められた操作: Certify 

   <span class="o">(</span>S<span class="o">)</span> 署名機能を反転する
   <span class="o">(</span>A<span class="o">)</span> 認証機能を反転する
   <span class="o">(</span>Q<span class="o">)</span> 完了
</code></pre></div>

<p>現在の認められた操作からSignが消えました。<code>q</code>を入力して完了します。</p>
<div class="highlight"><pre><span></span><code>ご希望の楕円曲線を選択してください:
   <span class="o">(</span><span class="m">1</span><span class="o">)</span> Curve <span class="m">25519</span>
   <span class="o">(</span><span class="m">2</span><span class="o">)</span> Curve <span class="m">448</span>
   <span class="o">(</span><span class="m">3</span><span class="o">)</span> NIST P-256
   <span class="o">(</span><span class="m">4</span><span class="o">)</span> NIST P-384
   <span class="o">(</span><span class="m">5</span><span class="o">)</span> NIST P-521
   <span class="o">(</span><span class="m">9</span><span class="o">)</span> secp256k1
</code></pre></div>

<p>希望の楕円曲線を選べることになります。Githubにソースコードをあげるときの署名のことを考えると、Curve 448は対応していないので<code>1</code>のCurve 25519を選びます。</p>
<div class="highlight"><pre><span></span><code>あなたの選択は? <span class="m">1</span>
鍵の有効期限を指定してください。
         <span class="nv">0</span> <span class="o">=</span> 鍵は無期限
      &lt;n&gt;  <span class="o">=</span> 鍵は n 日間で期限切れ
      &lt;n&gt;w <span class="o">=</span> 鍵は n 週間で期限切れ
      &lt;n&gt;m <span class="o">=</span> 鍵は n か月間で期限切れ
      &lt;n&gt;y <span class="o">=</span> 鍵は n 年間で期限切れ
鍵の有効期間は? <span class="o">(</span><span class="m">0</span><span class="o">)</span>
</code></pre></div>

<p>主鍵は<code>0</code>の無期限でよいと思います。漏れたらおしまいなのでそうなんども期限更新する手間とかいろいろ考えると無期限の方が安心できる気がします。</p>
<div class="highlight"><pre><span></span><code>鍵の有効期間は? <span class="o">(</span><span class="m">0</span><span class="o">)</span>
鍵は無期限です
これで正しいですか? <span class="o">(</span>y/N<span class="o">)</span> 
</code></pre></div>

<p>正しいので<code>y</code>を入力します。</p>
<div class="highlight"><pre><span></span><code>これで正しいですか? <span class="o">(</span>y/N<span class="o">)</span> y

GnuPGはあなたの鍵を識別するためにユーザIDを構成する必要があります。

本名:
</code></pre></div>

<p>本名を入力しましょう。ユニーク名で活動するならその名前でもいいかもしれません。この例では<code>John Doe</code>さんにしています。</p>
<div class="highlight"><pre><span></span><code>本名: John Doe
電子メール・アドレス: 
</code></pre></div>

<p>メールアドレスも入力します。この例では正しいメールアドレスではない、<code>john@doe</code>としています。</p>
<div class="highlight"><pre><span></span><code>電子メール・アドレス: john@doe
コメント: 
</code></pre></div>

<p>コメントは何も入力せずそのまま<code>Enterキー</code>を押します。何か入力してもよいです。</p>
<div class="highlight"><pre><span></span><code>名前<span class="o">(</span>N<span class="o">)</span>、コメント<span class="o">(</span>C<span class="o">)</span>、電子メール<span class="o">(</span>E<span class="o">)</span>の変更、またはOK<span class="o">(</span>O<span class="o">)</span>か終了<span class="o">(</span>Q<span class="o">)</span>? 
</code></pre></div>

<p>OKなので<code>o</code>を入力します。</p>
<p><img alt="主鍵パスワード入力" src="./images/gpg-input-pass.png"></p>
<p>パスワード入力画面が表示されます。秘密鍵はそのまま秘密鍵として使えるとあまりにも危険なので、パスワードで保護するようになっています。その為、適度なパスワードを設定しましょう。打ち間違い防止のため同じパスワードを上下に入力する必要があります。</p>
<div class="highlight"><pre><span></span><code>次のユーザIDを選択しました:
    <span class="s2">&quot;John Doe &lt;john@doe&gt;&quot;</span>

名前<span class="o">(</span>N<span class="o">)</span>、コメント<span class="o">(</span>C<span class="o">)</span>、電子メール<span class="o">(</span>E<span class="o">)</span>の変更、またはOK<span class="o">(</span>O<span class="o">)</span>か終了<span class="o">(</span>Q<span class="o">)</span>? o
たくさんのランダム・バイトの生成が必要です。キーボードを打つ、マウスを動か
す、ディスクにアクセスするなどの他の操作を素数生成の間に行うことで、乱数生
成器に十分なエントロピーを供給する機会を与えることができます。
gpg: 鍵3C0CAA5EE8FC0031を究極的に信用するよう記録しました
gpg: 失効証明書を <span class="s1">&#39;/home/john/.gnupg/openpgp-revocs.d/28A2FB1E3A9A6DAC90ACD7943C0CAA5EE8FC0031.rev&#39;</span> に保管しました。
公開鍵と秘密鍵を作成し、署名しました。

pub   ed25519 <span class="m">2022</span>-12-11 <span class="o">[</span>C<span class="o">]</span>
      28A2FB1E3A9A6DAC90ACD7943C0CAA5EE8FC0031
uid                      John Doe &lt;john@doe&gt;

$ 
</code></pre></div>

<p>これで一つの鍵ペア(主鍵)を作成することができました。失効証明書というのは、もし秘密鍵が漏洩したり、秘密鍵をなくしてしまったり、とにかく秘密鍵をもうこれからは使いませんというのを表明する為のファイルです。秘密鍵が無くなってからは作ることができないのと、失効証明書自体は単体で使えるので、このファイルも盗まれると困ることになります。USBメモリなどにコピーして大事にしまっておきましょう。</p>
<p>さて、きちんと鍵が生成されたか確認してみましょう。<code>gpg --list-keys</code>コマンドが鍵の一覧表示です。<code>gpg -k</code>がその短縮形になります。</p>
<div class="highlight"><pre><span></span><code>$ gpg -k
gpg: 信用データベースの検査
gpg: marginals needed: <span class="m">3</span>  completes needed: <span class="m">1</span>  trust model: pgp
gpg: 深さ: <span class="m">0</span>  有効性:   <span class="m">1</span>  署名:   <span class="m">0</span>  信用: <span class="m">0</span>-, 0q, 0n, 0m, 0f, 1u
/home/john/.gnupg/pubring.kbx
-----------------------------
pub   ed25519 <span class="m">2022</span>-12-11 <span class="o">[</span>C<span class="o">]</span>
      28A2FB1E3A9A6DAC90ACD7943C0CAA5EE8FC0031
uid           <span class="o">[</span>  究極  <span class="o">]</span> John Doe &lt;john@doe&gt;
</code></pre></div>

<p><code>pub</code>から始まる行がpublicキーつまり公開鍵の行です。ed25519で作成日が表示され、<code>[C]</code>というCertificationの機能が付与されていることがわかります。Certificationのみなので、副鍵を作ることにしか使えません。その下の<code>uid</code>の行は、入力したUser IDの情報です。このUser IDは、主鍵の公開鍵に紐付いているので、副鍵をたくさん作っても、uidは変わりません。このuidは追加したり削除することができます。実際の運用では、主鍵の秘密鍵が唯一の本人を証明する鍵の基になるので、あまり主鍵を入れ替えて新しい鍵を使うということは少ないようです。そのため、メールアドレスが変わった・名前が変わった等の場合は、<code>uid</code>を追加していくことになります。また、削除すると今までに署名したりした時の名前・メールアドレスとの整合性や、記録が無くなってしまうので、過去に使っていたuidは削除ではなく取り消し(Revoke)という操作を行うことになります。</p>
<p><code>究極</code>っていうのは英語でも<code>Ultimate</code>なので一緒なのですが、信用度のレベルです。自分自身で作ったので究極に信用できるってことです。この公開鍵を公開しても他の人に対して究極に信用できるという意味ではなく、自分が信用できるかどうかという意味です。</p>
<p>そして、秘密鍵の一覧を表示するには<code>gpg --list-secret-keys</code>を実行します。短縮コマンドは<code>gpg -K</code>です。先ほどと違って<code>K</code>が大文字になっています。</p>
<div class="highlight"><pre><span></span><code>$ gpg -K
/home/john/.gnupg/pubring.kbx
-----------------------------
sec   ed25519 <span class="m">2022</span>-12-11 <span class="o">[</span>C<span class="o">]</span>
      28A2FB1E3A9A6DAC90ACD7943C0CAA5EE8FC0031
uid           <span class="o">[</span>  究極  <span class="o">]</span> John Doe &lt;john@doe&gt;
</code></pre></div>

<p>先ほどと似たような画面ですが、<code>sec</code>から始まる行が秘密鍵の行です。次の行の英数字の羅列は<code>fingerprint</code>です。鍵IDではありません。鍵IDを表示するには、<code>--keyid-format short</code>等のオプションをつける必要があります。</p>
<div class="highlight"><pre><span></span><code>$ gpg -K --keyid-format short
/home/john/.gnupg/pubring.kbx
-----------------------------
sec   ed25519/E8FC0031 <span class="m">2022</span>-12-11 <span class="o">[</span>C<span class="o">]</span>
      28A2FB1E3A9A6DAC90ACD7943C0CAA5EE8FC0031
uid         <span class="o">[</span>  究極  <span class="o">]</span> John Doe &lt;john@doe&gt;
</code></pre></div>

<p><code>sec</code>行の<code>ed25519</code>の後にスラッシュがあり、その後に続いている8桁の英数字が鍵IDのショートバージョンになります。オプションを<code>short</code>から<code>long</code>に変えるともっと長いバージョンになりますが、大体shortで事が足ります。今は鍵のリストを表示しても一つしか出てきませんが、いろんな鍵をインポートしていくと増えるので、自分の鍵IDを記録しておき、<code>gpg -k E8FC0031</code>や<code>gpg -K E8FC0031</code>のような形で自分の鍵を表示すると見やすくなります。</p>
<h4>副鍵の作成</h4>
<p>次に主鍵に紐付く副鍵を作っていきます。SignとEncryptionとAuthenticationがあればOKです。</p>
<p>副鍵の作成は、主鍵を編集モードで開いて、鍵の追加を行う形です。鍵の編集は<code>--edit-key</code>オプションで行います。ここでも<code>--expert</code>オプションをつける必要があります。つけないと、鍵の種類の選択にRSAとDSAとElgamalしか出てきません。</p>
<div class="highlight"><pre><span></span><code>$ gpg --expert --edit-key E8FC0031
gpg <span class="o">(</span>GnuPG<span class="o">)</span> <span class="m">2</span>.3.3<span class="p">;</span> Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">2021</span> Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

秘密鍵が利用できます。

sec  ed25519/3C0CAA5EE8FC0031
     作成: <span class="m">2022</span>-12-11  有効期限: 無期限      利用法: C   
     信用: 究極        有効性: 究極
<span class="o">[</span>  究極  <span class="o">]</span> <span class="o">(</span><span class="m">1</span><span class="o">)</span>. John Doe &lt;john@doe&gt;

gpg&gt; 
</code></pre></div>

<p>選択した鍵の詳細が表示された後に、コンソールが<code>gpg&gt;</code>に変わります。ここからは専用のコマンドで設定していきます。先ほどの主鍵の作成では<code>gpg</code>コマンドにオプションを指定していましたが、副鍵はまた違った形で混乱しやすいポイントです。<code>addkey</code>と入力して鍵の作成に進みます。EncryptionとSignとAuthenticationの3つが必要なので、この手順を3回繰り返すイメージです。</p>
<h5>署名用の副鍵作成</h5>
<div class="highlight"><pre><span></span><code>gpg&gt; addkey
ご希望の鍵の種類を選択してください:
   <span class="o">(</span><span class="m">3</span><span class="o">)</span> DSA <span class="o">(</span>sign only<span class="o">)</span>
   <span class="o">(</span><span class="m">4</span><span class="o">)</span> RSA <span class="o">(</span>sign only<span class="o">)</span>
   <span class="o">(</span><span class="m">5</span><span class="o">)</span> Elgamal <span class="o">(</span>encrypt only<span class="o">)</span>
   <span class="o">(</span><span class="m">6</span><span class="o">)</span> RSA <span class="o">(</span>encrypt only<span class="o">)</span>
   <span class="o">(</span><span class="m">7</span><span class="o">)</span> DSA <span class="o">(</span><span class="nb">set</span> your own capabilities<span class="o">)</span>
   <span class="o">(</span><span class="m">8</span><span class="o">)</span> RSA <span class="o">(</span><span class="nb">set</span> your own capabilities<span class="o">)</span>
  <span class="o">(</span><span class="m">10</span><span class="o">)</span> ECC <span class="o">(</span>署名のみ<span class="o">)</span>
  <span class="o">(</span><span class="m">11</span><span class="o">)</span> ECC <span class="o">(</span><span class="nb">set</span> your own capabilities<span class="o">)</span>
  <span class="o">(</span><span class="m">12</span><span class="o">)</span> ECC <span class="o">(</span>encrypt only<span class="o">)</span>
  <span class="o">(</span><span class="m">13</span><span class="o">)</span> Existing key
  <span class="o">(</span><span class="m">14</span><span class="o">)</span> Existing key from card
あなたの選択は? 
</code></pre></div>

<p><code>11</code>のECC (set your own capabilities)を選びましょう。</p>
<div class="highlight"><pre><span></span><code>あなたの選択は? <span class="m">11</span>

このECC鍵にありうる操作: Sign Authenticate 
現在の認められた操作: Sign 

   <span class="o">(</span>S<span class="o">)</span> 署名機能を反転する
   <span class="o">(</span>A<span class="o">)</span> 認証機能を反転する
   <span class="o">(</span>Q<span class="o">)</span> 完了

あなたの選択は? 
</code></pre></div>

<p>最初から署名機能のSignが有効になっているので、このまま完了の<code>q</code>を入力します。</p>
<div class="highlight"><pre><span></span><code>あなたの選択は? q
ご希望の楕円曲線を選択してください:
   <span class="o">(</span><span class="m">1</span><span class="o">)</span> Curve <span class="m">25519</span>
   <span class="o">(</span><span class="m">2</span><span class="o">)</span> Curve <span class="m">448</span>
   <span class="o">(</span><span class="m">3</span><span class="o">)</span> NIST P-256
   <span class="o">(</span><span class="m">4</span><span class="o">)</span> NIST P-384
   <span class="o">(</span><span class="m">5</span><span class="o">)</span> NIST P-521
   <span class="o">(</span><span class="m">9</span><span class="o">)</span> secp256k1
あなたの選択は? 
</code></pre></div>

<p>楕円曲線は<code>(1)</code>のCurve 25519を選びます。</p>
<div class="highlight"><pre><span></span><code>あなたの選択は? <span class="m">1</span>
鍵の有効期限を指定してください。
         <span class="nv">0</span> <span class="o">=</span> 鍵は無期限
      &lt;n&gt;  <span class="o">=</span> 鍵は n 日間で期限切れ
      &lt;n&gt;w <span class="o">=</span> 鍵は n 週間で期限切れ
      &lt;n&gt;m <span class="o">=</span> 鍵は n か月間で期限切れ
      &lt;n&gt;y <span class="o">=</span> 鍵は n 年間で期限切れ
鍵の有効期間は? <span class="o">(</span><span class="m">0</span><span class="o">)</span>
</code></pre></div>

<p>副鍵の有効期限はいろいろな考え方があると思います。私は<code>1y</code>(1年)にしています。盗まれた・漏洩した後Revokeを公表したとして、それを知らない人がいたとしても有効期限が切れればそれ以上使うことはできません。また逆に短い有効期限は、有効期限の延長には主鍵が必要なので有効期限を延長する操作が頻繁になるとそれはそれで面倒になります。有効期限の延長は、最初の期限の設定のように好きな期間を設定できるので、とりあえず1yぐらいから始めてもいいかもしれません。</p>
<div class="highlight"><pre><span></span><code>鍵の有効期間は? <span class="o">(</span><span class="m">0</span><span class="o">)</span>1y
鍵は2023年12月XX日 10時00分00秒 JSTで期限切れとなります
これで正しいですか? <span class="o">(</span>y/N<span class="o">)</span> 
</code></pre></div>

<p>期限切れ日時に問題なさそうであれば、<code>y</code>を入力します。本当に？と聞かれるので2回です。</p>
<div class="highlight"><pre><span></span><code>これで正しいですか? <span class="o">(</span>y/N<span class="o">)</span> y
本当に作成しますか? <span class="o">(</span>y/N<span class="o">)</span> y
</code></pre></div>

<p>そうすると、パスワード入力画面が表示されます。ここでは主鍵を使って副鍵を証明する必要があるので、主鍵のパスワードを聞かれています。主鍵の作成時に入力したパスワードを入力してください。</p>
<p><img alt="副鍵パスワード入力" src="./images/gpg-input-pass2.jpg"></p>
<div class="highlight"><pre><span></span><code>たくさんのランダム・バイトの生成が必要です。キーボードを打つ、マウスを動か
す、ディスクにアクセスするなどの他の操作を素数生成の間に行うことで、乱数生
成器に十分なエントロピーを供給する機会を与えることができます。

sec  ed25519/3C0CAA5EE8FC0031
     作成: <span class="m">2022</span>-12-11  有効期限: 無期限      利用法: C   
     信用: 究極        有効性: 究極
ssb  ed25519/370329AF39BDAAC3
     作成: <span class="m">2022</span>-12-11  有効期限: <span class="m">2023</span>-12-11  利用法: S   
<span class="o">[</span>  究極  <span class="o">]</span> <span class="o">(</span><span class="m">1</span><span class="o">)</span>. John Doe &lt;john@doe&gt;

gpg&gt; 
</code></pre></div>

<p>この画面ではssbの行が増えて、副鍵が追加されたように見えます。実はこの操作は保存しないと反映されません。保存の為には<code>save</code>と入力します。失敗したら<code>q</code>で終了させれば副鍵の作成は無かったことになります。</p>
<div class="highlight"><pre><span></span><code>gpg&gt; save
$
</code></pre></div>

<h5>認証用の副鍵作成</h5>
<p>また<code>gpg --expert --edit-key KEYID</code>で鍵の編集から副鍵を作成します。
ほぼ同じ手順なので、出力は一部省略します。</p>
<div class="highlight"><pre><span></span><code>$ gpg --expert --edit-key E8FC0031
</code></pre></div>

<p><code>addkey</code>と入力します。</p>
<div class="highlight"><pre><span></span><code>gpg&gt; addkey 
</code></pre></div>

<p>また<code>11</code>を入力します。</p>
<div class="highlight"><pre><span></span><code>あなたの選択は? <span class="m">11</span>
</code></pre></div>

<p><code>s</code>と<code>a</code>を一回ずつ入力します。</p>
<div class="highlight"><pre><span></span><code>あなたの選択は? s

このECC鍵にありうる操作: Sign Authenticate 
現在の認められた操作: 

   <span class="o">(</span>S<span class="o">)</span> 署名機能を反転する
   <span class="o">(</span>A<span class="o">)</span> 認証機能を反転する
   <span class="o">(</span>Q<span class="o">)</span> 完了

あなたの選択は? a

このECC鍵にありうる操作: Sign Authenticate 
現在の認められた操作: Authenticate 

   <span class="o">(</span>S<span class="o">)</span> 署名機能を反転する
   <span class="o">(</span>A<span class="o">)</span> 認証機能を反転する
   <span class="o">(</span>Q<span class="o">)</span> 完了

あなたの選択は? 
</code></pre></div>

<p>これでAuthenticateの機能だけ選ぶことができます。<code>q</code>を押して完了させます。</p>
<div class="highlight"><pre><span></span><code>あなたの選択は? q
</code></pre></div>

<p><code>1</code>のCurve 25519を選びます。</p>
<div class="highlight"><pre><span></span><code>あなたの選択は? <span class="m">1</span>
</code></pre></div>

<p><code>1y</code>を入力します。</p>
<div class="highlight"><pre><span></span><code>鍵の有効期間は? <span class="o">(</span><span class="m">0</span><span class="o">)</span>1y
</code></pre></div>

<p>問題ないので<code>y</code>を2回と主鍵のパスワードを入力します。</p>
<div class="highlight"><pre><span></span><code>これで正しいですか? <span class="o">(</span>y/N<span class="o">)</span> y
本当に作成しますか? <span class="o">(</span>y/N<span class="o">)</span> y
たくさんのランダム・バイトの生成が必要です。キーボードを打つ、マウスを動か
す、ディスクにアクセスするなどの他の操作を素数生成の間に行うことで、乱数生
成器に十分なエントロピーを供給する機会を与えることができます。

sec  ed25519/3C0CAA5EE8FC0031
     作成: <span class="m">2022</span>-12-11  有効期限: 無期限      利用法: C   
     信用: 究極        有効性: 究極
ssb  ed25519/370329AF39BDAAC3
     作成: <span class="m">2022</span>-12-11  有効期限: <span class="m">2023</span>-12-11  利用法: S   
ssb  ed25519/EBDD86586431967C
     作成: <span class="m">2022</span>-12-11  有効期限: <span class="m">2023</span>-12-11  利用法: A   
<span class="o">[</span>  究極  <span class="o">]</span> <span class="o">(</span><span class="m">1</span><span class="o">)</span>. John Doe &lt;john@doe&gt;

gpg&gt; 
</code></pre></div>

<p><code>save</code>します。</p>
<div class="highlight"><pre><span></span><code>gpg&gt; save
$
</code></pre></div>

<h5>暗号化用の副鍵作成</h5>
<p>鍵の編集から副鍵を作成します。</p>
<div class="highlight"><pre><span></span><code>$ gpg --expert --edit-key E8FC0031
</code></pre></div>

<p><code>addkey</code>で副鍵を追加します。</p>
<div class="highlight"><pre><span></span><code>gpg&gt; addkey
</code></pre></div>

<p>次に鍵の種類ですが、前の手順と違って<code>12</code>のECC (encrypt only)を選びます。</p>
<div class="highlight"><pre><span></span><code>あなたの選択は? <span class="m">12</span>
</code></pre></div>

<p>楕円曲線は前の手順と同じく<code>(1) Curve 25519</code>を選びます。</p>
<div class="highlight"><pre><span></span><code>あなたの選択は? <span class="m">1</span>
</code></pre></div>

<p>有効期限は<code>1y</code>にします。</p>
<div class="highlight"><pre><span></span><code>鍵の有効期間は? <span class="o">(</span><span class="m">0</span><span class="o">)</span>1y
</code></pre></div>

<p>正しいはずなので<code>y</code>を2回と、主鍵のパスワードを入力します。</p>
<div class="highlight"><pre><span></span><code>これで正しいですか? <span class="o">(</span>y/N<span class="o">)</span> y
本当に作成しますか? <span class="o">(</span>y/N<span class="o">)</span> y
たくさんのランダム・バイトの生成が必要です。キーボードを打つ、マウスを動か
す、ディスクにアクセスするなどの他の操作を素数生成の間に行うことで、乱数生
成器に十分なエントロピーを供給する機会を与えることができます。

sec  ed25519/3C0CAA5EE8FC0031
     作成: <span class="m">2022</span>-12-11  有効期限: 無期限      利用法: C   
     信用: 究極        有効性: 究極
ssb  ed25519/370329AF39BDAAC3
     作成: <span class="m">2022</span>-12-11  有効期限: <span class="m">2023</span>-12-11  利用法: S   
ssb  ed25519/EBDD86586431967C
     作成: <span class="m">2022</span>-12-11  有効期限: <span class="m">2023</span>-12-11  利用法: A   
ssb  cv25519/CC620FA4AADE0E49
     作成: <span class="m">2022</span>-12-11  有効期限: <span class="m">2023</span>-12-11  利用法: E   
<span class="o">[</span>  究極  <span class="o">]</span> <span class="o">(</span><span class="m">1</span><span class="o">)</span>. John Doe &lt;john@doe&gt;

gpg&gt; 
</code></pre></div>

<p><code>save</code>します。</p>
<div class="highlight"><pre><span></span><code>gpg&gt; save
$ 
</code></pre></div>

<h5>作成した鍵の確認</h5>
<p><code>gpg -k</code>を実行します。</p>
<div class="highlight"><pre><span></span><code>$ gpg -k
/home/john/.gnupg/pubring.kbx
-----------------------------
pub   ed25519 <span class="m">2022</span>-12-11 <span class="o">[</span>C<span class="o">]</span>
      28A2FB1E3A9A6DAC90ACD7943C0CAA5EE8FC0031
uid           <span class="o">[</span>  究極  <span class="o">]</span> John Doe &lt;john@doe&gt;
sub   ed25519 <span class="m">2022</span>-12-11 <span class="o">[</span>S<span class="o">]</span> <span class="o">[</span>有効期限: <span class="m">2023</span>-12-11<span class="o">]</span>
sub   ed25519 <span class="m">2022</span>-12-11 <span class="o">[</span>A<span class="o">]</span> <span class="o">[</span>有効期限: <span class="m">2023</span>-12-11<span class="o">]</span>
sub   cv25519 <span class="m">2022</span>-12-11 <span class="o">[</span>E<span class="o">]</span> <span class="o">[</span>有効期限: <span class="m">2023</span>-12-11<span class="o">]</span>
</code></pre></div>

<p>公開鍵の一覧が表示されます。<code>pub</code>の行が主鍵で、<code>sub</code>が副鍵で3行あります。それぞれ<code>[S]</code>と<code>[A]</code>と<code>[E]</code>で別々の機能をもった鍵になっています。</p>
<p>今度は<code>gpg -K</code>を実行します。</p>
<div class="highlight"><pre><span></span><code>$ gpg -K
/home/john/.gnupg/pubring.kbx
-----------------------------
sec   ed25519 <span class="m">2022</span>-12-11 <span class="o">[</span>C<span class="o">]</span>
      28A2FB1E3A9A6DAC90ACD7943C0CAA5EE8FC0031
uid           <span class="o">[</span>  究極  <span class="o">]</span> John Doe &lt;john@doe&gt;
ssb   ed25519 <span class="m">2022</span>-12-11 <span class="o">[</span>S<span class="o">]</span> <span class="o">[</span>有効期限: <span class="m">2023</span>-12-11<span class="o">]</span>
ssb   ed25519 <span class="m">2022</span>-12-11 <span class="o">[</span>A<span class="o">]</span> <span class="o">[</span>有効期限: <span class="m">2023</span>-12-11<span class="o">]</span>
ssb   cv25519 <span class="m">2022</span>-12-11 <span class="o">[</span>E<span class="o">]</span> <span class="o">[</span>有効期限: <span class="m">2023</span>-12-11<span class="o">]</span>
</code></pre></div>

<p>秘密鍵の一覧が表示されます。同じように主鍵と副鍵３つが表示されます。</p>
<h4>鍵のバックアップ</h4>
<p>ついに鍵を作ったので、早速使いたいところですがまずは鍵のバックアップをしましょう。秘密鍵が消えたらもう何もできないので、大切に保管することが大事です。</p>
<p>まずバックアップに使えるエクスポートがあります。そのエクスポートにはバイナリ形式とテキスト形式があります。バイナリorテキストは好みですが、テキストの方がコピペできたり使い勝手がよいので、ここではテキスト形式で説明をします。</p>
<p>また、エクスポートの形式には複数ありますが、ここで３つ紹介します。</p>
<ul>
<li>公開鍵のエクスポート</li>
<li>公開鍵と秘密鍵全部のエクスポート</li>
<li>公開鍵と秘密鍵の副鍵のエクスポート(主鍵の秘密鍵だけがない)</li>
</ul>
<p>上記のうち、上二つだけでいいのではないかと思うかもしれません。実際の運用を考えた場合、今回の構成では署名や暗号化には副鍵を使います。その為主鍵が手元にある必要がありません。漏洩の可能性があるので、主鍵以外を手元に置いておく方が安全です。また、副鍵が漏洩したり無くなってしまった場合には、主鍵を元に副鍵を取り消し(Revoke)でき、新たに副鍵を作ってそちらを使うことができます。その場合にも公開鍵(と一緒のuid等)を他の人にお知らせするだけで済みます。</p>
<p>あと、秘密鍵を失くしたり漏洩した時に取り消すためのRevocationファイル（失効証明書）もバックアップした方が良いです。主鍵を作成した時に自動で作成されていますが、探すのが面倒なのでこちらもコマンドでエクスポートしてバックアップしましょう。</p>
<h5>公開鍵のエクスポート</h5>
<p>公開鍵をテキストファイルとしてエクスポートします。<code>-a</code>オプションをつけると、テキスト形式になります。<code>--export</code>オプションの後には鍵IDを指定してください。下記の例では鍵ID E8FC0031の鍵をjohn-pub.ascにテキストファイルとしてエクスポートします。</p>
<div class="highlight"><pre><span></span><code>$ gpg -a --export E8FC0031 &gt; john-pub.asc
</code></pre></div>

<p>公開鍵のファイルの内容を確認してみます。</p>
<div class="highlight"><pre><span></span><code>$ cat ./john-pub.asc 
-----BEGIN PGP PUBLIC KEY BLOCK-----

mDMEY5WH4RYJKwYBBAHaRw8BAQdAK37G3RSwogO+MiQOJG19P4VDu/YQUGV60sRF
HUpdoxe0E0pvaG4gRG9lIDxqb2huQGRvZT6IlAQTFgoAPBYhBCii+x46mm2skKzX
lDwMql7o/AAxBQJjlYfhAhsBBQsJCAcCAyICAQYVCgkICwIEFgIDAQIeBwIXgAAK
CRA8DKpe6PwAMSaaAQDM0T62VL2V1KmnZ+JuY1z9mhnIY/1jJsx4IdftU7lvLgEA
yAz/5McIWu5vrVTKOk7Xw5VT4nj3ZA2km1RqL34JagK4MwRjlfEyFgkrBgEEAdpH
DwEBB0BK+lcKe84zikiRnGN/SjJeoO3Ey0Rpfar02jp7+FA1AYj1BBgWCgAmFiEE
KKL7HjqabayQrNeUPAyqXuj8ADEFAmOV8TICGwIFCQHhM4AAgQkQPAyqXuj8ADF2
IAQZFgoAHRYhBJdoFjybcyzRmM5YrzcDKa85varDBQJjlfEyAAoJEDcDKa85varD
ygMA/Rjr4QZSTGisJmbzVjmf67ufeg0qtATOGGc6QWN4INWSAQAAlwROFHTLVy2l
ARy+kK7V5KcXMGETBYkYbPLmBxOtDWnxAQCJ4/3ABpNaTgLgJvdwjDyi8vtAVYTI
TPJUCjV6/QaMywD/V7CngnAJm4mkvsREZMqC4f7bF5LaTaxjPk0oW8/aoQO4MwRj
lfyyFgkrBgEEAdpHDwEBB0A3Swoa8RFP3p5CBh3rU6SeLmO2r8+Drl3iCj1eqz7l
KIh+BBgWCgAmFiEEKKL7HjqabayQrNeUPAyqXuj8ADEFAmOV/LICGyAFCQHhM4AA
CgkQPAyqXuj8ADFsgwD8D1p0Z+MxKuoR/0bN2HSBcmnDelkkz+kPQ00rF8DkfLEB
AN9KkMnpuV//s5XjLsemmsLDawyO1bFZ6lAdRfsltKACuDgEY5YQmRIKKwYBBAGX
VQEFAQEHQPBXUx6sh2insjEcoY7v9Uc9slABcwI601SOhdGiFFowAwEIB4h+BBgW
CgAmFiEEKKL7HjqabayQrNeUPAyqXuj8ADEFAmOWEJkCGwwFCQHhM4AACgkQPAyq
Xuj8ADEKBQD/XUhKmGOO/cM1UcjXIDdsa+/iDpoj1JdLaAjcdDT/ht4A/i/N2K4+
<span class="nv">LIgSwnU1dAOtrddn0K0bIKVwZSBUasAZMrIG</span>
<span class="o">=</span>W4A2
-----END PGP PUBLIC KEY BLOCK-----
</code></pre></div>

<p>1行目がBEGIN PGP PUBLIC KEY BLOCKとなっており、Public keyつまり公開鍵ということがわかります。</p>
<h5>秘密鍵全部のエクスポート</h5>
<p>執筆中...</p>
<h5>秘密鍵の副鍵エクスポート（主鍵以外をエクスポート）</h5>
<p>執筆中...</p>
<h5>失効証明書のエクスポート</h5>
<p>執筆中...</p>
<p>長くなってきたので続きは後編に</p>
<div class="footnote">
<hr>
<ol>
<li id="fn:1">
<p>https://people.csail.mit.edu/rivest/pubs/RSA78.pdf&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
            </div>
            <div class="post_list">
                <span>By </span>
                <a href="./author/akio-tomita.html">@Akio Tomita</a>
                <span> in </span>
                <span class="post_category"><a href="./category/miracle-linux-9.html" rel="bookmark"
                                               title="Permalink to MIRACLE LINUX 9">[ MIRACLE LINUX 9 ]</a></span>
                <span class="post_date">Sun 11 December 2022</span>
                <div><span>Tags : </span>
                </div>

                <div class="entry-social">
                    <span class="twitter"><a target="_blank" rel="nofollow"
                                             onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=400,width=700');return false;"
                                             title="Twitter"
                                             href="https://twitter.com/share?url=./miracle-linux-9-tips-gpg.html&text=GnuPGを運用する&via="><img
                            src="./theme/images/icons/twitter-s.png"></a></span>

                    <span class="gplus"><a target="_blank" title="Google +"
                                           href="https://plus.google.com/share?url=./miracle-linux-9-tips-gpg.html&hl=fr"
                                           rel="nofollow"
                                           onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;"><img
                            src="./theme/images/icons/google-s.png"></a></span>

                    <span class="facebook"><a target="_blank" title="Facebook" rel="nofollow"
                                              onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=700');return false;"
                                              href="https://www.facebook.com/sharer.php?u=./miracle-linux-9-tips-gpg.html&t=GnuPGを運用する"><img
                            src="./theme/images/icons/facebook-s.png"></a></span>

                    <a target="_blank" title="Linkedin"
                       href="https://www.linkedin.com/shareArticle?mini=true&url=./miracle-linux-9-tips-gpg.html&title=GnuPGを運用する"
                       rel="nofollow"
                       onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;"><img
                            src="./theme/images/icons/linkedin-s.png"></a>

                    <span class="mail"><a
                            href="mailto:?subject=GnuPGを運用する&amp;body=Viens découvrir un article à propos de [GnuPGを運用する] sur le site de Akio Tomita. ./miracle-linux-9-tips-gpg.html"
                            title="Share by Email" target="_blank"><img
                            src="./theme/images/icons/mail-s.png"></a></span>
                </div>
            </div>
        </article>
    </section>
</article>

<!-- Footer -->
    <footer>
        <p>
            Blog powered by <a href="http://getpelican.com/">Pelican</a>,
            which takes great advantage of <a href="http://python.org">Python</a>.
            Theme <a href="https://github.com/parbhat/pelican-blue">Pelican-Blue</a> by <a
                href="https://parbhatpuri.com/">@parbhat</a>.
        </p>
    </footer>


</body>
</html>